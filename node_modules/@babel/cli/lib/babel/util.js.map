{"version":3,"names":["chmod","src","dest","fs","chmodSync","statSync","mode","err","console","warn","readdir","dirname","includeDotfiles","filter","readdirRecursive","filename","index","currentDirectory","stat","path","join","isDirectory","readdirForCompilable","altExts","isCompilableExtension","exts","babel","DEFAULT_EXTENSIONS","ext","extname","includes","addSourceMappingUrl","code","loc","basename","hasDataSourcemap","pos","lastIndexOf","length","CALLER","name","transformRepl","opts","caller","Promise","resolve","reject","transform","result","compile","transformFile","externalDependencies","watcher","updateExternalDependencies","deleteDir","existsSync","readdirSync","forEach","file","curPath","lstatSync","unlinkSync","rmdirSync","process","on","error","exitCode","withExtension","newBasename","debounce","fn","time","timer","debounced","clearTimeout","setTimeout","flush"],"sources":["../../src/babel/util.ts"],"sourcesContent":["import readdirRecursive from \"fs-readdir-recursive\";\nimport * as babel from \"@babel/core\";\nimport path from \"path\";\nimport fs from \"fs\";\n\nimport * as watcher from \"./watcher\";\n\nimport type { FileResult, InputOptions } from \"@babel/core\";\n\nexport function chmod(src: string, dest: string): void {\n  try {\n    fs.chmodSync(dest, fs.statSync(src).mode);\n  } catch (err) {\n    console.warn(`Cannot change permissions of ${dest}`);\n  }\n}\n\ntype ReaddirFilter = (filename: string) => boolean;\n\nexport function readdir(\n  dirname: string,\n  includeDotfiles: boolean,\n  filter?: ReaddirFilter,\n): Array<string> {\n  return readdirRecursive(dirname, (filename, index, currentDirectory) => {\n    const stat = fs.statSync(path.join(currentDirectory, filename));\n\n    if (stat.isDirectory()) return true;\n\n    return (\n      (includeDotfiles || filename[0] !== \".\") && (!filter || filter(filename))\n    );\n  });\n}\n\nexport function readdirForCompilable(\n  dirname: string,\n  includeDotfiles: boolean,\n  altExts?: Array<string>,\n): Array<string> {\n  return readdir(dirname, includeDotfiles, function (filename) {\n    return isCompilableExtension(filename, altExts);\n  });\n}\n\n/**\n * Test if a filename ends with a compilable extension.\n */\nexport function isCompilableExtension(\n  filename: string,\n  altExts?: readonly string[],\n): boolean {\n  const exts = altExts || babel.DEFAULT_EXTENSIONS;\n  const ext = path.extname(filename);\n  return exts.includes(ext);\n}\n\nexport function addSourceMappingUrl(code: string, loc: string): string {\n  return code + \"\\n//# sourceMappingURL=\" + path.basename(loc);\n}\n\nexport function hasDataSourcemap(code: string): boolean {\n  const pos = code.lastIndexOf(\"\\n\", code.length - 2);\n  return pos != -1 && code.lastIndexOf(\"//# sourceMappingURL\") < pos;\n}\n\nconst CALLER = {\n  name: \"@babel/cli\",\n};\n\nexport function transformRepl(filename: string, code: string, opts: any) {\n  opts = {\n    ...opts,\n    caller: CALLER,\n    filename,\n  };\n\n  return new Promise<FileResult>((resolve, reject) => {\n    babel.transform(code, opts, (err, result) => {\n      if (err) reject(err);\n      else resolve(result);\n    });\n  });\n}\n\nexport async function compile(filename: string, opts: InputOptions) {\n  opts = {\n    ...opts,\n    caller: CALLER,\n  };\n\n  // TODO (Babel 8): Use `babel.transformFileAsync`\n  const result = await new Promise<FileResult>((resolve, reject) => {\n    babel.transformFile(filename, opts, (err, result) => {\n      if (err) reject(err);\n      else resolve(result);\n    });\n  });\n\n  if (result) {\n    if (!process.env.BABEL_8_BREAKING) {\n      if (!result.externalDependencies) return result;\n    }\n    watcher.updateExternalDependencies(filename, result.externalDependencies);\n  }\n\n  return result;\n}\n\nexport function deleteDir(path: string): void {\n  if (fs.existsSync(path)) {\n    fs.readdirSync(path).forEach(function (file) {\n      const curPath = path + \"/\" + file;\n      if (fs.lstatSync(curPath).isDirectory()) {\n        // recurse\n        deleteDir(curPath);\n      } else {\n        // delete file\n        fs.unlinkSync(curPath);\n      }\n    });\n    fs.rmdirSync(path);\n  }\n}\n\nprocess.on(\"uncaughtException\", function (err) {\n  console.error(err);\n  process.exitCode = 1;\n});\n\nexport function withExtension(filename: string, ext: string = \".js\") {\n  const newBasename = path.basename(filename, path.extname(filename)) + ext;\n  return path.join(path.dirname(filename), newBasename);\n}\n\nexport function debounce(fn: () => void, time: number) {\n  let timer: NodeJS.Timeout;\n  function debounced() {\n    clearTimeout(timer);\n    timer = setTimeout(fn, time);\n  }\n  debounced.flush = () => {\n    clearTimeout(timer);\n    fn();\n  };\n  return debounced;\n}\n"],"mappings":"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"}